<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kazanım Bazlı Analiz - Mersin Etkin Zümre</title>
    
    <link rel="preload" as="image" href="EZKLogo.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- MASTER CSS (Aynı) --- */
        :root { --meb-red: #E30A17; --corporate-dark: #0F172A; --bg-light: #f8fafc; --text-gray: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-gray); overflow-x: hidden; }
        a { text-decoration: none; color: inherit; transition: 0.3s; }
        ul { list-style: none; }
        .container { width: 94%; max-width: 1400px; margin: 0 auto; }

        /* HEADER & NAV */
        .top-header { background: white; padding: 10px 0; border-bottom: 1px solid #e2e8f0; height: 100px; display: flex; align-items: center; }
        .top-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .brand-area { display: flex; align-items: center; gap: 5px; }
        .logo-fixed { width: 80px; height: 80px; background-image: url('EZKLogo.png'); background-size: contain; background-repeat: no-repeat; background-position: center left; display: block; }
        .brand-text h1 { font-size: 1.6rem; font-weight: 900; color: var(--corporate-dark); margin: 0; }
        .brand-text span { font-size: 0.9rem; color: #64748b; font-weight: 600; }
        .slogan-text { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-style: italic; color: var(--meb-red); font-weight: 600; }

        .main-nav { background-color: var(--corporate-dark); position: sticky; top: 0; z-index: 1000; border-top: 4px solid var(--meb-red); height: 60px; }
        .nav-container { width: 94%; max-width: 1400px; margin: 0 auto; display: flex; align-items: center; height: 100%; }
        .nav-link { color: rgba(255, 255, 255, 0.9); font-weight: 600; font-size: 0.9rem; padding: 0 22px; height: 60px; display: flex; align-items: center; border-right: 1px solid rgba(255,255,255,0.06); }
        .nav-link:hover, .nav-item:hover .nav-link { background-color: var(--meb-red); color: white; }
        
        .nav-item { position: relative; height: 100%; display: flex; align-items: center; }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; background: white; min-width: 260px; box-shadow: 0 15px 30px rgba(0,0,0,0.15); border-top: 3px solid var(--meb-red); z-index: 9999; }
        .nav-item:hover .dropdown-menu { display: block; }
        .dropdown-item a { display: block; padding: 12px 20px; color: #333; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; font-weight: 500; }
        .dropdown-item a:hover { background: #f8fafc; color: var(--meb-red); padding-left: 25px; }

        /* LAYOUT */
        .layout { display: flex; gap: 30px; padding: 40px 0; min-height: 80vh; }
        .config-panel { flex: 0 0 350px; background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; height: fit-content; position: sticky; top: 80px; }
        .panel-title { color: var(--corporate-dark); border-bottom: 2px solid var(--meb-red); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2rem; }
        
        label { font-size: 0.85rem; font-weight: 700; color: #475569; display: block; margin-bottom: 5px; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        
        .kazanim-row { display: grid; grid-template-columns: 40px 1fr 60px; gap: 10px; align-items: center; margin-bottom: 8px; }
        .kazanim-row span { font-weight: bold; color: var(--meb-red); }
        
        .btn-action { background: var(--corporate-dark); color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        .btn-action:hover { background: var(--meb-red); }

        .content-panel { flex: 1; display: flex; flex-direction: column; gap: 30px; }
        .step-box { background: white; padding: 30px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .paste-area { width: 100%; height: 200px; font-family: monospace; font-size: 0.85rem; background: #f8fafc; border: 2px dashed #cbd5e1; padding: 15px; resize: vertical; white-space: pre; overflow: auto; }
        
        .result-section { display: none; }
        .success-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .success-table th { text-align: left; padding: 12px; background: #f1f5f9; border-bottom: 2px solid #cbd5e1; font-size: 0.85rem; color: #475569; }
        .success-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        
        .progress-bar-bg { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }
        
        .chart-wrapper { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; height: 400px; position: relative; }

        @media (max-width: 1000px) { .layout { flex-direction: column; } .config-panel { position: static; width: 100%; } }
        @media print { .top-header, .main-nav, .config-panel, .step-box { display: none; } .result-section { display: block; } .chart-wrapper { page-break-inside: avoid; border: none; } }
    </style>
</head>
<body>

    <div class="top-header">
        <div class="container top-content">
            <div class="brand-area">
                <a href="index.html" class="logo-fixed"></a>
                <div class="brand-text">
                    <h1>MERSİN ETKİN ZÜMRE</h1>
                    <span>Eğitimde Birlik ve İlerleme Platformu</span>
                </div>
            </div>
            <div class="slogan-area"><span class="slogan-text">"Köklerden Geleceğe..."</span></div>
        </div>
    </div>

    <nav class="main-nav">
        <div class="container nav-container">
            <ul style="display:flex; height:100%;">
                <li class="nav-item"><a href="index.html" class="nav-link">ANASAYFA</a></li>
                <li class="nav-item"><a href="arsiv.html" class="nav-link">ZÜMRE ARŞİVİ</a></li>
                <li class="nav-item"><a href="yonetmelik.html" class="nav-link">YÖNETMELİK</a></li>
                <li class="nav-item">
                    <a href="tutanak.html" class="nav-link" style="background-color:#E30A17;">EVRAK OLUŞTUR <i class="fas fa-chevron-down" style="margin-left:5px; font-size:0.8rem;"></i></a>
                    <ul class="dropdown-menu">
                        <li class="dropdown-item"><a href="doc-zumre.html">Zümre Tutanağı</a></li>
                        <li class="dropdown-item"><a href="doc-plan.html">Yıllık Plan</a></li>
                        <li class="dropdown-item"><a href="doc-sinav.html">Yazılı Sınav</a></li>
                        <li class="dropdown-item"><a href="doc-kazanim.html" style="color:#E30A17; font-weight:700;">Kazanım Analizi</a></li>
                    </ul>
                </li>
                <li class="nav-item"><a href="maarif.html" class="nav-link">MAARİFİ ANLAMAK</a></li>
                <li class="nav-item"><a href="ilceler.html" class="nav-link">İLÇE ZİYARETLERİ</a></li>
                <li class="nav-item"><a href="ornekler.html" class="nav-link">İYİ ÖRNEKLER</a></li>
                <li class="nav-item"><a href="forum.html" class="nav-link">FORUM</a></li>
            </ul>
        </div>
    </nav>

    <div class="container layout">
        
        <div class="config-panel">
            <h3 class="panel-title">1. Sınav Ayarları</h3>
            
            <label>Soru Sayısı</label>
            <input type="number" id="qCount" value="10" min="1" max="50" onchange="generateOutcomeInputs()">
            
            <label>Sınav Başlığı</label>
            <input type="text" id="examTitle" placeholder="Örn: 9. Sınıf Kimya 1. Dönem 1. Yazılı">

            <div style="margin-top:20px; max-height:400px; overflow-y:auto; border-top:1px solid #e2e8f0; padding-top:10px;">
                <label style="margin-bottom:10px;">Soru Kazanımları ve Puanları</label>
                <div id="outcomeInputs">
                    </div>
            </div>
        </div>

        <div class="content-panel">
            
            <div class="step-box">
                <h3 style="color:#0F172A; margin-bottom:10px;">2. Öğrenci Sonuçlarını Yapıştır</h3>
                <p style="color:#64748b; font-size:0.9rem; margin-bottom:15px;">
                    Excel'den sadece öğrenci isimleri ve soru puanlarını seçip kopyalayın.<br>
                    <small>İpucu: Eğer notlarda "8,5" gibi virgül varsa sistem otomatik düzeltir.</small>
                </p>
                <textarea id="dataArea" class="paste-area" placeholder="Excel'den Direkt Yapıştırın:
Ali Yılmaz	10	5	10	...
Ayşe Demir	10	10	10	..."></textarea>
                <button class="btn-action" onclick="analyzeOutcomes()"><i class="fas fa-chart-pie"></i> Analiz Et ve Raporla</button>
            </div>

            <div id="results" class="result-section">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="reportTitle" style="color:#0F172A;">Sınav Analiz Raporu</h2>
                    <button onclick="window.print()" style="padding:10px 20px; border:1px solid #ccc; background:white; border-radius:5px; cursor:pointer;"><i class="fas fa-print"></i> Yazdır</button>
                </div>

                <div class="chart-wrapper">
                    <canvas id="outcomeChart"></canvas>
                </div>

                <h3 style="margin-top:30px; color:#0F172A;">Kazanım Başarı Tablosu</h3>
                <table class="success-table">
                    <thead>
                        <tr>
                            <th width="50">Soru</th>
                            <th>Kazanım / Konu</th>
                            <th width="80">Puan</th>
                            <th width="100">Sınıf Ort.</th>
                            <th width="200">Başarı Düzeyi</th>
                            <th width="60">%</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>

            </div>

        </div>
    </div>

    <script>
        // Sayfa yüklendiğinde varsayılan inputları oluştur
        window.onload = function() { generateOutcomeInputs(); };

        let myChart = null;

        function generateOutcomeInputs() {
            const count = parseInt(document.getElementById('qCount').value);
            const container = document.getElementById('outcomeInputs');
            container.innerHTML = "";

            for(let i=1; i<=count; i++) {
                container.innerHTML += `
                    <div class="kazanim-row">
                        <span>S.${i}</span>
                        <input type="text" id="kazanim_${i}" placeholder="Konu/Kazanım">
                        <input type="number" id="puan_${i}" value="10" placeholder="Pn">
                    </div>
                `;
            }
        }

        function analyzeOutcomes() {
            const qCount = parseInt(document.getElementById('qCount').value);
            const rawData = document.getElementById('dataArea').value.trim();
            
            if(!rawData) { alert("Lütfen veri yapıştırın."); return; }

            // 1. Kazanım ve Max Puanları Topla
            let questions = [];
            for(let i=1; i<=qCount; i++) {
                questions.push({
                    id: i,
                    text: document.getElementById(`kazanim_${i}`).value || `Soru ${i}`,
                    max: parseFloat(document.getElementById(`puan_${i}`).value) || 0,
                    totalScore: 0
                });
            }

            let studentCount = 0;
            const lines = rawData.split('\n');

            // 2. Veriyi Satır Satır İşle
            lines.forEach(line => {
                let cleanLine = line.trim();
                if(cleanLine === "") return;

                // Excel'de sekmeler (\t) veya boşluklarla ayrılmış olabilir.
                // Regex: Boşluk veya Tab karakterlerine göre böl
                const parts = cleanLine.split(/\s+/);

                // Eğer parçalanan satır, soru sayısından büyükse veri var demektir.
                // İsim soyisim başta olacağı için, notlar SONDAKİ qCount kadar elemandır.
                if(parts.length > qCount) {
                    // Sondan qCount kadar veriyi al (Notlar)
                    const scoresRaw = parts.slice(-qCount);
                    
                    let validLine = true; 
                    // Geçici toplamları tut
                    let tempScores = [];

                    for(let i=0; i<qCount; i++) {
                        // Virgülü noktaya çevir (TR Excel fix)
                        let valStr = scoresRaw[i].replace(',', '.');
                        let score = parseFloat(valStr);
                        
                        // Eğer sayı değilse (örn: "G" girdi vb.) 0 kabul et veya hata vermesini engelle
                        if(isNaN(score)) score = 0;
                        
                        tempScores.push(score);
                    }

                    // Eğer buraya kadar geldiyse bu satır geçerli bir öğrencidir
                    if(validLine) {
                        for(let k=0; k<qCount; k++) {
                            questions[k].totalScore += tempScores[k];
                        }
                        studentCount++;
                    }
                }
            });

            if(studentCount === 0) { 
                alert("Veri formatı anlaşılamadı. Lütfen 'İsim Puan Puan...' formatında olduğundan emin olun."); 
                return; 
            }

            // 3. Hesaplama ve Tablo Oluşturma
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            
            const chartLabels = [];
            const chartData = [];
            const chartColors = [];

            questions.forEach(q => {
                const classAvg = q.totalScore / studentCount;
                // Eğer max puan girilmemişse (0 ise) bölme hatası olmasın
                const successRate = q.max > 0 ? (classAvg / q.max) * 100 : 0;
                
                // Renk Skalası
                let color = '#ef4444'; // Kırmızı (0-49)
                if(successRate >= 50) color = '#f59e0b'; // Sarı (50-69)
                if(successRate >= 70) color = '#22c55e'; // Yeşil (70-100)

                chartLabels.push(`S.${q.id}`);
                chartData.push(successRate.toFixed(1));
                chartColors.push(color);

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${q.id}</strong></td>
                        <td>${q.text}</td>
                        <td>${q.max}</td>
                        <td>${classAvg.toFixed(2)}</td>
                        <td>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width:${successRate}%; background-color:${color};"></div>
                            </div>
                        </td>
                        <td><strong>%${successRate.toFixed(0)}</strong></td>
                    </tr>
                `;
            });

            // Başlık Güncelle
            const title = document.getElementById('examTitle').value;
            if(title) document.getElementById('reportTitle').innerText = title + " - Kazanım Analizi";

            // 4. Grafiği Çiz
            renderChart(chartLabels, chartData, chartColors, questions);
            
            // Sonuç Alanını Aç
            const resultDiv = document.getElementById('results');
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({behavior: 'smooth'});
        }

        function renderChart(labels, data, colors, questions) {
            const ctx = document.getElementById('outcomeChart').getContext('2d');
            if(myChart) myChart.destroy();

            // Tooltip verisi
            const tooltips = questions.map(q => q.text);

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Başarı Oranı (%)',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const idx = context[0].dataIndex;
                                    return `Soru ${idx+1}: ${tooltips[idx]}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, title: {display:true, text:'Başarı %'} }
                    }
                }
            });
        }
    </script>

</body>
</html>